---
title: "„Ç≥„É≥„ÉÜ„Éä„Çπ„Éà„É¨„Éº„Ç∏„Å´ÁâπÂåñ„Åó„Åü„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†ComposeFS„Å®„ÅØ"
emoji: "üç∫"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: []
published: false
---
# „ÅØ„Åò„ÇÅ„Å´

Êú¨Ë®ò‰∫ã„ÅØ„ÄÅOpenShift Advent Calendar 2024„ÅÆ12/3„ÅÆË®ò‰∫ã„Åß„ÄÅcomposefs„Å®„ÅÑ„ÅÜ„Ç≥„É≥„ÉÜ„ÉäÁí∞Â¢ÉÂêë„Åë„ÅÆ„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†„ÇíÁ¥π‰ªã„Åó„Åæ„Åô„ÄÇ

composefs„ÅØ„ÄÅÁèæÂú®„ÅÆ„Å®„Åì„Çç„ÄÅ„Ç≥„É≥„ÉÜ„Éä„Çπ„Éà„É¨„Éº„Ç∏„Åä„Çà„Å≥OSTree„Éô„Éº„Çπ„ÅÆOS„Ç§„É°„Éº„Ç∏„ÅÆ„É™„Éù„Ç∏„Éà„É™„Å®„Åó„Å¶„ÅÆ„É¶„Éº„Çπ„Ç±„Éº„Çπ„ÅåËÄÉ„Åà„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÊú¨Ë®ò‰∫ã„Åß„ÅØ„ÄÅ„Ç≥„É≥„ÉÜ„Éä„Çπ„Éà„É¨„Éº„Ç∏„Å®„Åó„Å¶„ÅÆ„É¶„Éº„Çπ„Ç±„Éº„Çπ„Å´„Éï„Ç©„Éº„Ç´„Çπ„Åó„Åæ„Åô„ÄÇ

„Ç≥„É≥„ÉÜ„Éä„ÅÆÊñáËÑà„Åß„ÅØ„ÄÅcomposefs„ÅØ„Äå„Éï„Ç°„Ç§„É´Âçò‰Ωç„ÅßÈáçË§áÊéíÈô§„Åå„Åß„Åç„Çã„Ç≥„É≥„ÉÜ„Éä„Çπ„Éà„É¨„Éº„Ç∏„Äç„ÇíÊèê‰æõ„Åô„Çã„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†„Å®Ë®Ä„Åà„Åæ„Åô„ÄÇÈÄöÂ∏∏„ÅÆ„Ç≥„É≥„ÉÜ„Éä„Ç§„É°„Éº„Ç∏„ÅØ„ÄÅ„É¨„Ç§„É§„Éº„Åî„Å®„Å´SHA256„ÅÆ„Éè„ÉÉ„Ç∑„É•ÂÄ§„ÇíË®àÁÆó„Åó„ÄÅË§áÊï∞„ÅÆ„Ç≥„É≥„ÉÜ„Éä„Ç§„É°„Éº„Ç∏„ÅßÂêå„Åò„É¨„Ç§„É§„Éº„Çí‰ΩøÁî®„Åô„ÇãÂ†¥Âêà„ÅØ„Åù„ÅÆ„É¨„Ç§„É§„Éº„ÇíÂÖ±Êúâ„Åô„Çã„Åì„Å®„Åß„ÄÅ„Ç§„É°„Éº„Ç∏„É¨„Ç§„É§„Éº„Åî„Å®„ÅÆÈáçË§áÊéíÈô§„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇcomposefs„Çí‰ΩøÁî®„Åô„Çã„Å®„ÄÅ„Çà„ÇäÁ≤íÂ∫¶„ÅÆÁ¥∞„Åã„ÅÑ„Éï„Ç°„Ç§„É´Âçò‰Ωç„Åß„ÅÆÈáçË§áÊéíÈô§Ë°å„ÅÜ„Åì„Å®„Åå„Åß„Åç„Åæ„Åô (Ë§áÊï∞„ÅÆ„É¨„Ç§„É§„Éº„Å´Âêå„Åò„Éê„Ç§„Éä„É™„ÅåÂÖ•„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ1ÂÄãÂàÜ„ÅÆ„Çπ„Éà„É¨„Éº„Ç∏ÂÆπÈáè„Åó„Åã‰Ωø„ÅÑ„Åæ„Åõ„Çì)„ÄÇ

„Å™„Çì„ÅßOpenShift„Å®„ÅØÈñ¢‰øÇ„Å™„ÅÑcomposefs„ÇíAdvent Calendar„ÅÆ„Éç„Çø„Å´„Åó„Å¶„ÅÑ„Çã„Åã„Å®„ÅÑ„ÅÑ„Åæ„Åô„Å®... OpenShift„ÅÆ„Éé„Éº„Éâ„ÅØ„ÄåRHEL CoreOS„Äç„Å®„ÅÑ„ÅÜLinux„Éá„Ç£„Çπ„Éà„É™„Éì„É•„Éº„Ç∑„Éß„É≥„Çí‰Ωø„Å£„Å¶„ÅÑ„Çã„ÅÆ„Åß„Åô„Åå„ÄÅ„Åù„ÅÆ„Ç¢„ÉÉ„Éó„Çπ„Éà„É™„Éº„É†„Åß„ÅÇ„ÇãFedora CoreOS„Åß„ÅØ„ÄÅÂÆü„ÅØcomposefs„Åå‰Ωø„Çè„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Å®„ÅÑ„ÅÜ„Çè„Åë„Åß„ÄÅ„Åù„Çå„Åª„Å©ÈÅ†„Åè„Å™„ÅÑÂ∞ÜÊù•„ÄÅOpenShift„Å´ÂÖ•„Å£„Å¶„Åè„Çã(„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ)Ê©üËÉΩ[^1]„Å®„ÅÑ„ÅÜ„Åì„Å®„Åß„ÄÅ„ÅîÂÆπËµ¶„Åè„Å†„Åï„ÅÑ... 

[^1]: Â§ñ„Åã„ÇâË¶ã„Åà„ÇãJIRA„ÉÅ„Ç±„ÉÉ„Éà„ÇÇ„ÅÇ„Çä„Åæ„Åó„Åü https://issues.redhat.com/browse/COS-2963

# composefs„ÅÆÊ©üËÉΩ

composefs„ÅØ„ÄÅ„ÅÑ„Åè„Å§„Åã„ÅÆÁâπÂæ¥„ÇíÊåÅ„Å§Êñ∞„Åó„ÅÑ„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†„Åß„Åô„ÄÇ

ÂÖ∏ÂûãÁöÑ„Å™„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†„ÅØ„Éñ„É≠„ÉÉ„ÇØ„Éá„Éê„Ç§„Çπ„Çí„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´ÊåÅ„Å°„Åæ„Åô„Åå„ÄÅÂØæ„Åó„Å¶composefs„ÅØÈÄöÂ∏∏„ÅÆread-only„ÅÆ„Éï„Ç°„Ç§„É´„ÅÆÈõÜÂêà„Çí„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´ÊåÅ„Å°„Åæ„Åô„ÄÇÂà•„ÅÆË®Ä„ÅÑÊñπ„Çí„Åô„Çã„Å®„ÄÅ„Äå„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å®„Å™„ÇãÈÄöÂ∏∏„ÅÆ„Éï„Ç°„Ç§„É´„ÅÆÈõÜÂêà (Ôºã„É°„Çø„Éá„Éº„Çø„ÅÆÊÉÖÂ†±) „Å´ÂØæ„Åó„Å¶composefs„Éû„Ç¶„É≥„Éà„Åô„Çã„Äç„Å®„ÅÑ„ÅÜ„ÄÅ„ÅÇ„ÇãÁ®Æ„ÅÆ„É´„Éº„Éó„Éê„ÉÉ„ÇØ„Éû„Ç¶„É≥„Éà„Çí„Åô„Çã„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†„Åß„Åô„ÄÇ

„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å®„Å™„Çã„Éï„Ç°„Ç§„É´Áæ§„ÅØ„ÄÅ„Äåcontent-addressed backing files„Äç„Å®Âëº„Å∞„Çå„Åæ„Åô„ÄÇcontent addressed„Å®„ÅÑ„ÅÜË®ÄËëâ„ÅØ„ÄÅ„Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπ„Åã„Çâ„Éï„Ç°„Ç§„É´„ÇíÊåáÂÆö„Åß„Åç„Çã„ÄÅ„Å®„ÅÑ„ÅÜÊ∞óÊåÅ„Å°„ÅåËæº„ÇÅ„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÂÖ∑‰ΩìÁöÑ„Å´„ÅØ„ÄÅ„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„ÅÆ„Éï„Ç°„Ç§„É´„ÅØ„ÄÅ„Éï„Ç°„Ç§„É´„ÅÆ‰∏≠Ë∫´„ÅÆSHA256„ÅÆ„Éè„ÉÉ„Ç∑„É•ÂÄ§„Åå„Éï„Ç°„Ç§„É´Âêç„Å®„Å™„Çä„Åæ„Åô„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊ©üÂô®„Å´„ÅØÊê≠Ëºâ„Åï„Çå„Å¶„ÅÑ„ÇãCAM (Content Addressable Memory, ÈÄ£ÊÉ≥„É°„É¢„É™) „ÅåÊÉ≥Ëµ∑„Åï„Çå„ÇãË®ÄËëâ„Åß„Åô„ÄÇMAC„ÉÜ„Éº„Éñ„É´„ÇÑ„É´„Éº„ÉÜ„Ç£„É≥„Ç∞„ÉÜ„Éº„Éñ„É´„ÅÆÊ§úÁ¥¢„Çí„Éè„Éº„Éâ„Ç¶„Çß„Ç¢„ÅßÈ´òÈÄüÂá¶ÁêÜ„Åô„Çã„ÄÇ

composefs„ÅØ„ÄÅfs-verity„Çí‰Ωø„Å£„Å¶„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†ÂÖ®‰Ωì„ÅÆÊîπ„Åñ„ÇìÊ§úÁü•„Åå„Åß„Åç„Åæ„Åô„ÄÇfs-verity„ÅØLinux„Ç´„Éº„Éç„É´„ÅåÊåÅ„Å§„Éï„Ç°„Ç§„É´Âçò‰Ωç„ÅÆÊîπ„Åñ„ÇìÊ§úÁü•„ÇíË°å„ÅÜ‰ªïÁµÑ„Åø„Åß„Åô„ÄÇfs-verityËá™‰Ωì„ÅØ„ÄÅ„Éï„Ç°„Ç§„É´„ÅÆ‰∏≠Ë∫´„Å´„Åó„ÅãÈñ¢‰∏é„Åó„Åæ„Åõ„Çì„ÄÇ„Å§„Åæ„Çäfs-veryty„Åß„ÅØ„É°„Çø„Éá„Éº„Çø„ÅÆÂ§âÊõ¥„ÅØÊ§úÁü•„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Åó„Åã„Åócomposefs„ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†„ÅÆ„É°„Çø„Éá„Éº„Çø/„Éá„Ç£„É¨„ÇØ„Éà„É™„ÉÑ„É™„Éº„ÇíEROFS„ÅÆ„Ç§„É°„Éº„Ç∏„Å®„Åó„Å¶ÊåÅ„Å§„Åü„ÇÅ„ÄÅ„Åì„ÅÆ„Ç§„É°„Éº„Ç∏„Éï„Ç°„Ç§„É´„Å´ÂØæ„Åó„Å¶„ÇÇfs-verity„ÅÆ„ÉÄ„Ç§„Ç∏„Çß„Çπ„Éà„ÇíÁ¢∫Ë™ç„Åô„Çã„Åì„Å®„Åß„ÄÅ„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†ÂÖ®‰Ωì„ÅÆÊîπ„Åñ„ÇìÊ§úÁü•„Åå„Åß„Åç„Åæ„Åô„ÄÇ

# ‰Ωø„ÅÑÊñπ

composefs„ÅßÈÅä„Å∂„Åü„ÇÅ„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™„ÉÑ„É™„Éº„ÇíÈÅ©ÂΩì„Å´‰Ωú„Çä„Åæ„Åô„ÄÇ

```
$ tree rootfs
rootfs
‚îú‚îÄ‚îÄ foo.txt
‚îú‚îÄ‚îÄ subdir
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ bar.txt
‚îî‚îÄ‚îÄ testfile

2 directories, 3 files
```



```
$ python -c 'print("foo.txt" + "_" * 60)' > rootfs/foo.txt
$ python -c 'print("bar.txt" + "_" * 60)' > rootfs/subdir/bar.txt
$ echo 'abcde' > rootfs/testfile
```


```
$ mkcomposefs --digest-store=objects rootfs example.cfs
```

example.cfs„Å®„ÅÑ„ÅÜerofs„ÅÆ„Ç§„É°„Éº„Ç∏„Éï„Ç°„Ç§„É´„Å®„ÄÅobjects„Å®„ÅÑ„ÅÜ„Éá„Ç£„É¨„ÇØ„Éà„É™ÈÖç‰∏ã„Å´„ÅÑ„Åè„Å§„Åã„ÅÆ„Éï„Ç°„Ç§„É´„Åå‰ΩúÊàê„Åï„Çå„Åæ„Åô„ÄÇ

```
$ file example.cfs
example.cfs: EROFS filesystem, compat: MTIME, blocksize=12, exslots=0, uuid=00000000-0000-0000-0000-000000000000
```

```
$ tree objects
objects
‚îú‚îÄ‚îÄ 85
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ d600d462f5c3738b55c3ebf570c31263353dc6aa35448c6a8f9aa519429c8a
‚îî‚îÄ‚îÄ fc
    ‚îî‚îÄ‚îÄ 2a1a56808b1739e0fb1621d2170b42d9cfd57c54f7481b1c29935e440fd8a4

3 directories, 2 files
```

„Éû„Ç¶„É≥„Éà„Éù„Ç§„É≥„Éà„Çí‰Ωú„Å£„Å¶„Éû„Ç¶„É≥„Éà„Åó„Åæ„Åô„ÄÇ

```
$ sudo mkdir -p /mnt/composefs
$ sudo mount -t composefs -o basedir=objects example.cfs /mnt/composefs
```

```
$ findmnt -J | jq '.filesystems[].children[] | select(.target == "/mnt/composefs")'
{
  "target": "/mnt/composefs",
  "source": "composefs",
  "fstype": "overlay",
  "options": "ro,relatime,seclabel,lowerdir+=/tmp/.composefs.aONLgi,datadir+=objects,redirect_dir=on,metacopy=on"
}
```

mkcomposefs„ÅßÁîüÊàê„Åï„Çå„Åüerofs„ÅÆ„Ç§„É°„Éº„Ç∏„Éï„Ç°„Ç§„É´„Ååloopback„Éû„Ç¶„É≥„Éà„Åï„Çå„Å¶„ÅÑ„Çã„Åì„Å®„Åå„Çè„Åã„Çä„Åæ„Åô„ÄÇ

```
$ losetup
NAME       SIZELIMIT OFFSET AUTOCLEAR RO BACK-FILE                            DIO LOG-SEC
/dev/loop0         0      0         1  1 /home/ori/work/composefs/example.cfs   1    4096
```

/mnt/composefs„Å´„ÅØrootfs„Å®Âêå„ÅòÂÜÖÂÆπ„ÅÆ„Éï„Ç°„Ç§„É´„ÅåË¶ã„Åà„Åæ„Åô„ÄÇ

```
$ tree /mnt/composefs
/mnt/composefs
‚îú‚îÄ‚îÄ foo.txt
‚îú‚îÄ‚îÄ subdir
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ bar.txt
‚îî‚îÄ‚îÄ testfile

2 directories, 3 files
```

```
$ cat /mnt/composefs/foo.txt
foo.txt____________________________________________________________
$ cat /mnt/composefs/subdir/bar.txt
bar.txt____________________________________________________________
$ cat /mnt/composefs/testfile
abcde
```

erofs„ÅÆ„Ç§„É°„Éº„Ç∏„Éï„Ç°„Ç§„É´„ÇÇ„Éû„Ç¶„É≥„Éà„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ

```
$ sudo mkdir -p /mnt/erofs
$ sudo mount -oloop /dev/loop0 /mnt/erofs
```

```
$ findmnt -J | jq '.filesystems[].children[] | select(.target == "/mnt/erofs")'
{
  "target": "/mnt/erofs",
  "source": "/dev/loop1",
  "fstype": "erofs",
  "options": "ro,relatime,seclabel,user_xattr,acl,cache_strategy=readaround"
}
```

```
$ ls -l /mnt/erofs
total 12
crw-r--r--. 1 ori ori 0, 0 Dec  4 15:06 00
crw-r--r--. 1 ori ori 0, 0 Dec  4 15:06 01
...
crw-r--r--. 1 ori ori 0, 0 Dec  4 15:06 fe
crw-r--r--. 1 ori ori 0, 0 Dec  4 15:06 ff
-rw-r--r--. 1 ori ori   68 Dec  4 15:07 foo.txt
drwxr-xr-x. 2 ori ori   46 Dec  4 11:45 subdir
-rw-r--r--. 1 ori ori    6 Dec  4 15:07 testfile
```

maj 0, min 0„ÅÆchardev„Éï„Ç°„Ç§„É´„Åå„Åü„Åè„Åï„Çì„Å®„ÄÅ„ÅÇ„Å®rootfs„Å´„ÅÇ„Å£„Åü„Éï„Ç°„Ç§„É´„ÅåË¶ã„Åà„Åæ„Åô„ÄÇ„Åù„Çå„Åû„Çå„Éï„Ç°„Ç§„É´„ÅÆÊã°ÂºµÂ±ûÊÄß„ÇíË¶ã„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ

```
$ sudo getfattr -d -m - /mnt/erofs/foo.txt
getfattr: Removing leading '/' from absolute path names
# file: mnt/erofs/foo.txt
security.selinux="unconfined_u:object_r:user_home_t:s0"
trusted.overlay.metacopy=0sACQAAYXWANRi9cNzi1XD6/VwwxJjNT3GqjVEjGqPmqUZQpyK
trusted.overlay.redirect="/85/d600d462f5c3738b55c3ebf570c31263353dc6aa35448c6a8f9aa519429c8a"
```

```
$ sudo getfattr -d -m - /mnt/erofs/subdir/bar.txt
getfattr: Removing leading '/' from absolute path names
# file: mnt/erofs/subdir/bar.txt
security.selinux="unconfined_u:object_r:user_home_t:s0"
trusted.overlay.metacopy=0sACQAAfwqGlaAixc54PsWIdIXC0LZz9V8VPdIGxwpk15ED9ik
trusted.overlay.redirect="/fc/2a1a56808b1739e0fb1621d2170b42d9cfd57c54f7481b1c29935e440fd8a4"
```

```
$ sudo getfattr -d -m - /mnt/erofs/testfile
getfattr: Removing leading '/' from absolute path names
# file: mnt/erofs/testfile
security.selinux="unconfined_u:object_r:user_home_t:s0"
```

`foo.txt`„ÄÅ`subdir/bar.txt` „Å´„ÅØ `trusted.overlay.redirect` „ÅÆÊã°ÂºµÂ±ûÊÄß„ÅåË®≠ÂÆö„Åï„Çå„Å¶„Åä„Çä„ÄÅmkcomposefsÂÆüË°åÊôÇ„Å´ `--digest-store` „ÅßÊåáÂÆö„Åó„Åü„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çπ„Éà„Ç¢„Å´ÁîüÊàê„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÅÆ„Éë„Çπ„ÅåÊõ∏„Åã„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ

composefs„Åß„Éï„Ç°„Ç§„É´„Å´„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Å®„ÄÅ„Åæ„Åöerofs„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™„ÉÑ„É™„Éº„Çí„Åü„Å©„Å£„Å¶ÊåáÂÆö„Åó„Åü„Éë„Çπ„ÇíÊé¢„Åó„ÄÅ„Åù„ÅÆ„Éï„Ç°„Ç§„É´„ÅÆÊã°ÂºµÂ±ûÊÄß `trusted.overlay.redirect` „ÇíË¶ã„Å¶„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çπ„Éà„Ç¢ÂÜÖ„ÅÆ„Éï„Ç°„Ç§„É´„Å´Âà∞ÈÅî„Åó„Åæ„Åô„ÄÇfoo.txt„ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çπ„Éà„Ç¢ÂÜÖ„ÅÆ `85/d600d462f5c3738b55c3ebf570c31263353dc6aa35448c6a8f9aa519429c8a` „Å´„Åù„ÅÆ„Éá„Éº„Çø„ÅåÂÖ•„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ

```
$ cat /mnt/composefs/foo.txt
foo.txt____________________________________________________________
$ sudo getfattr -d -m - /mnt/erofs/foo.txt
getfattr: Removing leading '/' from absolute path names
# file: mnt/erofs/foo.txt
security.selinux="unconfined_u:object_r:user_home_t:s0"
trusted.overlay.metacopy=0sACQAAYXWANRi9cNzi1XD6/VwwxJjNT3GqjVEjGqPmqUZQpyK
trusted.overlay.redirect="/85/d600d462f5c3738b55c3ebf570c31263353dc6aa35448c6a8f9aa519429c8a"
$ cat objects/85/d600d462f5c3738b55c3ebf570c31263353dc6aa35448c6a8f9aa519429c8a
foo.txt____________________________________________________________
```

„Å°„Å™„Åø„Å´„ÄÅ„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„Åå64„Éê„Ç§„ÉàÊú™Ê∫Ä„ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çπ„Éà„Ç¢„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Åõ„Åö„ÄÅerofs„ÅÆ„Ç§„É°„Éº„Ç∏ÂÜÖ„Å´Áõ¥Êé•„Éï„Ç°„Ç§„É´„Éá„Éº„Çø„ÇíÂüã„ÇÅËæº„Åø„Åæ„Åô„ÄÇ‰∏äË®ò„ÅÆ‰æã„Åß„ÄÅ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çπ„Éà„Ç¢ÂÜÖ„Å´„Éï„Ç°„Ç§„É´„Åå2ÂÄã„Åó„Åã„Å™„Åè„ÄÅerofs„Ç§„É°„Éº„Ç∏ÂÜÖ„ÅÆtestdata„ÅÆÊã°ÂºµÂ±ûÊÄß `trusted.overlay.redirect` „ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„Åã„Å£„Åü„ÅÆ„ÅØ„Åù„ÅÆ„Åü„ÇÅ„Åß„Åô„ÄÇ

# Podman„Åã„Çâcomposefs„Çí‰Ωø„ÅÜ

# Ê≠¥Âè≤

ÊúÄÂàù„ÅØ„ÄÅÊñ∞Ë¶è„ÅÆÁã¨Ëá™„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†„Å®„ÅÑ„ÅÜÂΩ¢„Åß„ÄÅ2022Âπ¥11Êúà„Å´ÊúÄÂàù„ÅÆRFC patch„ÅåLKML„Å´ÊäïÁ®ø„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Åì„ÅÆÂæåË≠∞Ë´ñ„ÇíÈáç„Å≠„Å™„Åå„Çâv2, v3„Å®„Éë„ÉÉ„ÉÅ„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åô„Åå„ÄÅ„Å©„Å°„Çâ„Åã„Å®„ÅÑ„ÅÜ„Å®„ÅÇ„Åæ„Çä„Ç´„Éº„Éç„É´„Ç≥„Éü„É•„Éã„ÉÜ„Ç£„Åã„Çâ„ÅÆË≥õÂêå„ÅØÂæó„Çâ„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÇÄ„Åó„ÇçÊèêÊ°à„Åï„Çå„Åü„É¶„Éº„Çπ„Ç±„Éº„Çπ„Åß„ÅÇ„Çå„Å∞„ÄÅÊñ∞„Åó„ÅÑ„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†„Çí‰Ωú„Çã„Çà„Çä„ÇÇ„ÄÅ‰ºº„ÅüÊ©üËÉΩ„ÇíÊåÅ„Å§Êó¢Â≠ò„ÅÆ‰ªïÁµÑ„Åø (overlayfs„ÄÅerofsÁ≠â) „ÇíÊîπËâØ„Åô„ÇãÊñπ„Åå„Çà„ÅÑ„ÅÆ„Åß„ÅØ„Å™„ÅÑ„Åã„ÄÅ„Å®„ÅÑ„ÅÜÊÑèË¶ã„ÅåÂá∫„Åæ„Åó„Åü„ÄÇ

- [[PATCH RFC 0/6] Composefs: an opportunistically sharing verified image filesystem](https://lore.kernel.org/lkml/cover.1669631086.git.alexl@redhat.com/)
- [[PATCH v2 0/6] Composefs: an opportunistically sharing verified image filesystem](https://lore.kernel.org/lkml/cover.1673623253.git.alexl@redhat.com/)
- [[PATCH v3 0/6] Composefs: an opportunistically sharing verified image filesystem](https://lore.kernel.org/lkml/cover.1674227308.git.alexl@redhat.com/)

„Åù„ÅÆÂæå„ÄÅ2023Âπ¥„ÅÆLSFMM/BPF Summit„ÇíÁµå„Å¶„ÄÅcomposefs„ÅØ„Ç´„Éº„Éç„É´ÂÜÖ„ÅÆÊñ∞Ë¶è„ÅÆ„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†„Åß„ÅØ„Å™„Åè„ÄÅ„Äå„É°„Çø„Éá„Éº„Çø„ÇÑ„Éá„Ç£„É¨„ÇØ„Éà„É™„ÉÑ„É™„Éº„Çíerofs„ÅÆ„Ç§„É°„Éº„Ç∏„Å®„Åó„ÄÅ„Éï„Ç°„Ç§„É´„Éá„Éº„Çø„Çícontent-addressed„Å™„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„ÄÅ„Åù„Çå„Çâ„Çíoverlayfs„ÅßÁµÑ„ÅøÂêà„Çè„Åõ„Çã„Äç„Å®„ÅÑ„ÅÜÊñπÂêë„Å´ÊñπÈáùËª¢Êèõ„Åô„Çã„Åì„Å®„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇ

„Åù„ÅÆÂæå„ÄÅCopmoseFS„ÇíÂÆüÁèæ„Åô„Çã„Åü„ÇÅ„Å´„ÅÑ„Åè„Å§„Åã„ÅÆÊ©üËÉΩ„Ååoverlayfs„Å´ËøΩÂä†„Åï„Çå„Åæ„Åó„Åü„ÄÇ‰ª£Ë°®ÁöÑ„Å™„ÇÇ„ÅÆ„Å®„Åó„Å¶„ÅØ
- overlayfs„Åßmetadata only layer„Å®data only lower layer„ÇíÊåÅ„Å¶„Çã„Çà„ÅÜ„Å´„Åô„Çã https://lore.kernel.org/all/20230427130539.2798797-1-amir73il@gmail.com/
- overlayfs„Åßfs-verity„ÅÆ„Çµ„Éù„Éº„Éà https://lore.kernel.org/linux-unionfs/cover.1687345663.git.alexl@redhat.com/
„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ

Â§ß„Åæ„Åã„Å™ÊµÅ„Çå„ÅØ„ÄÅLWN„ÅÆ‰ª•‰∏ã„ÅÆË®ò‰∫ã„ÇíÈ†Ü„Å´Ë™≠„ÇÄ„Å®„Çè„Åã„Çä„ÇÑ„Åô„ÅÑ„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇ

- [Composefs for integrity protection and data sharing](https://lwn.net/Articles/917097/)
- [Debating composefs](https://lwn.net/Articles/922851/)
- [A decision on composefs](https://lwn.net/Articles/933616/)

# ÂèÇËÄÉÊñáÁåÆ

- composefs„ÅÆ„É™„Éù„Ç∏„Éà„É™
  - https://github.com/containers/composefs
- Alexander Larsson (composefs„ÅÆ‰∏ªË¶ÅÈñãÁô∫ËÄÖ„ÅÆ‰∏Ä‰∫∫„ÄÅLKML„Å´„Éë„ÉÉ„ÉÅ„ÇíÊäï„Åí„Åü‰∫∫) „ÅÆ„Éñ„É≠„Ç∞Ë®ò‰∫ã
  - [Using Composefs in OSTree](https://blogs.gnome.org/alexl/2022/06/02/using-composefs-in-ostree/)
  - [Composefs state of the union](https://blogs.gnome.org/alexl/2023/07/11/composefs-state-of-the-union/)
  - [Announcing composefs 1.0](https://blogs.gnome.org/alexl/2023/09/26/announcing-composefs-1-0/)
- Giuseppe Scrivano (composefs„ÅÆÈñãÁô∫ËÄÖ„ÅÆ‰∏Ä‰∫∫„ÄÅLKML„Åß„ÅÆË≠∞Ë´ñ„Å´ÂèÇÂä†„Åó„Å¶„ÅÑ„Çã‰∫∫„Åß„Åô) „ÅÆ„Éñ„É≠„Ç∞Ë®ò‰∫ã
  - [composefs - a file system for container images](https://www.scrivano.org/posts/2021-10-26-compose-fs/)

# footnotes

[

# xxx

Red Hat„ÅØÊúÄËøëOS„ÅÆ„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†Ëá™‰Ωì„Çí„Ç≥„É≥„ÉÜ„Éä„Ç§„É°„Éº„Ç∏„Å®„Åó„Å¶ÁÆ°ÁêÜ/ÈÖçÂ∏É„Åó„Çà„ÅÜ„Å®„Åó„Å¶„ÅÑ„Å¶„ÄÅ„Åù„Åì„Åß„ÇÇcomposefs„ÅÆÁâπÂæ¥„ÅåÊ¥ª„Åã„Åõ„Çã„ÅÆ„Åß„ÅØ„ÄÅ„Å®„ÅÑ„ÅÜ„Åì„Å®„Åß„ÄÅbootc„ÇÑostree„Å®composefs„ÅÆÈÄ£Êê∫„ÇÇ„ÅÑ„Çç„ÅÑ„ÇçÁîªÁ≠ñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ

RHEL/Fedora„ÅÆImage mode„Å´„Åä„Åë„Çã„Ç≥„Ç¢„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Åß„ÅÇ„Çãbootc„ÅØ„ÄÅupstream„Åß„ÅØÊó¢„Å´„Éá„Éï„Ç©„É´„Éà„Åßcomposefs„Çí‰ΩøÁî®„Åô„Çã„Çà„ÅÜ„Å´„Å™„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇhttps://github.com/containers/bootc/pull/304

ostree„ÅØÊó¢„Å´content addressable„Å™„É™„Éù„Ç∏„Éà„É™„Çí
https://github.com/ostreedev/ostree/issues/2867


```
$ sudo podman run --name web --rm -d -p 8080:80 quay.io/manabu.ori/myhttpd
9392c9fbe31d7ce8012d316b5b662b79c31953173bc03358c01bb693c2ba0f10
```


# Linux kernel

44dfd84a6d54a675e35ab618d9fab47b36cb78cd
teach move_mount(2) to work with OPEN_TREE_CLONE

2db154b3ea8e14b04fee23e3fdfd5e9d17fbc6ae
vfs: syscall: Add move_mount(2) to move mounts around

a07b20004793d8926f78d63eb5980559f7813404
vfs: syscall: Add open_tree(2) to reference or clone a mount

v1:
https://lore.kernel.org/linux-unionfs/20230408164302.1392694-1-amir73il@gmail.com/
https://lore.kernel.org/linux-unionfs/20230412135412.1684197-1-amir73il@gmail.com/

v2:
https://lore.kernel.org/all/20230427130539.2798797-1-amir73il@gmail.com/

37ebf056d6cfc6638c821386bc33a9602bbc0d28
ovl: introduce data-only lower layers

989974c804574d250ac92d44e220081959ac8ac1
ovl: Enable metadata only feature

ae8cba4033bc16e8a07792428a48a50710cc0f3c
ovl: Add framework for verity support

https://lore.kernel.org/linux-unionfs/cover.1687345663.git.alexl@redhat.com/

184996e92e86c4a4224dc4aaee75b2ccd04b6e78
ovl: Validate verity xattr when resolving lowerdata

2d2f2d7322ff43e0fe92bf8cccdc0b09449bf2e1
ovl: user xattr

459c7c565ac36ba09ffbf24231147f408fde4203
ovl: unprivieged mounts

## ???

d47748e5ae5af6572e520cc9767bbe70c22ea498
ovl: automatically enable redirect_dir on metacopy=on

4120fe64dce4f73d1a595253568d9f27674f2071
ovl: Set redirect on upper inode when it is linked

d5791044d2e5749ef4de84161cec5532e2111540
ovl: Provide a mount option metacopy=on/off for metadata copyup

9cec54c83a8baba3099bb8b445a735b93ab9511f
ovl: Initialize ovl_inode->redirect in ovl_get_inode()

# Phoronix

## EROFS

- [EROFS Lands FSCache-Based Shared Domain Support For Linux 6.1](https://www.phoronix.com/news/Linux-6.1-EROFS)
- [EROFS Gets Low-Latency Decompression For Much Better Performance](https://www.phoronix.com/news/Linux-6.3-EROFS-Faster)
- [EROFS Receives Some Useful Improvements With Linux 6.4](https://www.phoronix.com/news/Linux-6.4-EROFS)
- [EROFS File-System Adding DEFLATE Compression Support](https://www.phoronix.com/news/EROFS-DEFLATE-Coming)
- [EROFS Lands DEFLATE Compression, F2FS Improves Zoned Devices In Linux 6.6](https://www.phoronix.com/news/EROFS-F2FS-Linux-6.6)
- [EROFS No Longer Treating MicroLZMA Compression As Experimental](https://www.phoronix.com/news/EROFS-MicroLZMA-Stable)

## composefs

- [Red Hat Developers Announce Work On New "Composefs" File-System](https://www.phoronix.com/news/Composefs)

## Bcachefs

- [Bcachefs Submitted For Review - Next-Gen CoW File-System Aims For Mainline](https://www.phoronix.com/news/Bcachefs-For-Review-Linux)
- [It's Looking Like Bcachefs Won't Be Merged For Linux 6.5](https://www.phoronix.com/news/Linux-6.5-Bcachefs-Unlikely)
- [Bcachefs File-System Plans To Try Again To Land In Linux 6.6](https://www.phoronix.com/news/Bcachefs-Plans-For-Linux-6.6)
- [Linus Torvalds Reviews The Bcachefs File-System Code](https://www.phoronix.com/news/Linux-Torvalds-Bcachefs-Review)
- [Bcachefs File-System Re-Submitted For Linux 6.6](https://www.phoronix.com/news/Bcachefs-For-Linux-6.6-PR)
- [Linus Torvalds Comments On Bcachefs Prospects For Linux 6.6](https://www.phoronix.com/news/Linus-Comments-Bcachefs-6.6)
- [Bcachefs Looks Like It Won't Make It For Linux 6.6](https://www.phoronix.com/news/Bcachefs-Delayed-Linux-6.6)
- [Bcachefs Pull Request Submitted For Linux 6.7](https://www.phoronix.com/news/Bcachefs-Tries-For-Linux-6.7)
- [Bcachefs Merged Into The Linux 6.7 Kernel](https://www.phoronix.com/news/Bcachefs-Merged-Linux-6.7)

## PuzzleFS

- [Cisco Posts Rust-Written PuzzleFS File-System Driver For Linux](https://www.phoronix.com/news/Experimental-Rust-PuzzleFS)
- [PuzzleFS Continues Striving To Be The Best File-System For Containers](https://www.phoronix.com/news/PuzzleFS-Development-Continues)

## initoverlayfs?

- [Red Hat Looks For Feedback On Its New Initoverlayfs File-System Proposal](https://www.phoronix.com/news/Red-Hat-Initoverlayfs)

# zstd:chunked

- [Pull container images faster with partial pulls](https://www.redhat.com/sysadmin/faster-container-image-pulls)
- Container Plumbling Days 2021: [Starting up Containers Super Fast With Lazy Pulling of Images](https://www.slideshare.net/slideshow/starting-up-containers-super-fast-with-lazy-pulling-of-images/244154126)

# misc
- Fosdem 2024: [Composefs and containers](https://fosdem.org/2024/schedule/event/fosdem-2024-3250-composefs-and-containers/)


- Podman„Åßcomposefs„Åå‰Ωø„Åà„Çã„ÅÆ„ÅØrootful„ÅÆ„Åø (rootless„Åß„ÅØ‰Ωø„Åà„Å™„ÅÑ)
https://github.com/containers/storage/blob/v1.55.0/drivers/overlay/overlay.go#L383





`I see EROFS as a block device that uses fscache, and composefs as an overlay for files instead of directories.`
https://lore.kernel.org/lkml/878rhvg8ru.fsf@redhat.com/

ÂÖ®„Å¶„ÅÆ„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†„Ååfs-verify„Çí„Çµ„Éù„Éº„Éà„Åô„Çã„Çè„Åë„Åß„ÅØ„Å™„ÅÑ

userspace„Åß„Éû„Ç¶„É≥„Éà„Åô„Çã„ÅÆ„ÅØ„É™„Çπ„ÇØ„ÅåÈ´ò„ÅÑ„ÄÅÂ¢ó„ÇÑ„Åó„Åü„Åè„Å™„ÅÑ
At least Christian said, "FUSE and Overlayfs are adventurous enough and they don't have their own on-disk format."
https://lore.kernel.org/lkml/3ae1205a-b666-3211-e649-ad402c69e724@linux.alibaba.com/

